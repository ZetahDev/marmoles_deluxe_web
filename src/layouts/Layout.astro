---
import "../styles/global.css";
import { WhatsAppButton } from "../components/WhatsAppButton";
import { ScrollToTopButton } from "../components/ScrollToTopButton";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { ClientRouter } from "astro:transitions";
import SpeedInsights from "@vercel/speed-insights/astro";

interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "Mármoles Deluxe - Instalación, Transporte y Garantía de Mármoles",
} = Astro.props;
---

<!doctype html>
<html lang="es">
  <head>
    <!-- Google Tag Manager -->
    <script is:inline>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-TGX6Q25X");
    </script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      crossorigin="anonymous"
      media="print"
      onload="this.media='all'"
    />

    <meta
      name="facebook-domain-verification"
      content="v2kxgywlwg2k962jr77ep47ryjagd5"
    />
  </head>

  <body
    class="flex flex-col min-h-screen bg-marmoles-white text-marmoles-black"
  >
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-TGX6Q25X"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >
    <!-- End Google Tag Manager (noscript) -->

    <ClientRouter />

    <!-- Facebook Pixel (noscript) -->
    <noscript>
      <img
        height="1"
        width="1"
        style="display:none"
        src="https://www.facebook.com/tr?id=1756574061191176&ev=PageView&noscript=1"
      />
    </noscript>
    <!-- End Facebook Pixel (noscript) -->

    <Navbar />
    <main class="flex-grow">
      <slot />
    </main>
    <Footer />
    <WhatsAppButton client:idle />
    <ScrollToTopButton client:idle />
    <SpeedInsights />

    <script>
      // Interceptar navegación
      document.addEventListener("astro:before-navigation", (event) => {
        // Verificar si hay eventos pendientes antes de la navegación
        const pendingChanges =
          document.body.classList.contains("uploading") ||
          document.body.classList.contains("saving");

        if (pendingChanges) {
          const confirmed = confirm(
            "Hay cambios pendientes. ¿Deseas abandonar la página?"
          );
          if (!confirmed) {
            event.preventDefault();
          }
        }
      });

      // Escuchar eventos de autenticación
      window.addEventListener("auth-change", (event) => {
        const { isAuthenticated } = (event as CustomEvent).detail;
        // Manejar cambios de autenticación sin forzar recarga
        const currentPath = window.location.pathname;
        const isAdminRoute = currentPath.startsWith("/admin");

        if (!isAuthenticated && isAdminRoute && currentPath !== "/admin") {
          history.pushState({}, "", "/admin");
          window.dispatchEvent(new PopStateEvent("popstate"));
        }
      });
    </script>

    <!-- Meta Pixel Code -->
    <script is:inline>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js"
      );
      fbq("init", "1756574061191176");
      fbq("track", "PageView");
    </script>

    <!-- Google Analytics -->
    <script
      is:inline
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-NXQ0SL5DBV"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-NXQ0SL5DBV");
    </script>

    <!-- Analytics del Embudo de Ventas -->
    <script>
      import { initializeAnalytics } from "../lib/analytics";

      // Esperar a que el DOM y los scripts de analytics carguen
      window.addEventListener("load", function () {
        // Dar tiempo para que GTM, GA y FB Pixel se inicialicen
        setTimeout(() => {
          initializeAnalytics();
        }, 1000);
      });
    </script>
  </body>

  <style>
    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
    }

    /* Prevenir Layout Shifts */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }
  </style>

  <!-- Precargar imágenes críticas después de la carga inicial -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if ("requestIdleCallback" in window) {
        requestIdleCallback(() => {
          // Precargar logos cuando el navegador esté inactivo
          const imagesToPreload = [
            "/logos/Altea.webp",
            "/logos/silestone.webp",
          ];
          imagesToPreload.forEach((src) => {
            const img = new Image();
            img.src = src;
          });
        });
      }
    });
  </script>
</html>
