---
import Layout from "../layouts/Layout.astro";
import ProductCard from "../components/ProductCard.tsx";
import PageLoader from "../components/PageLoader.tsx";
import CategoryFilter from "../components/CategoryFilter.tsx";
import CategoryWrapper from "../components/CategoryWrapper.tsx";
import SEOSchemaData from "../components/SEOSchemaData.tsx";
import { listStonesFromS3, type Stone } from "../lib/utils/s3Utils";

// Define stone type features
interface StoneTypeFeatures {
  [key: string]: string[];
}

// Configuraci√≥n: usar anclas (#neolith) en lugar de par√°metros (?categoria=neolith)
const useAnchorLinks = true;

// Generate category descriptions for SEO (optimizado para b√∫squedas en Google)
const categoryDescriptions = {
  Altea:
    "Piedra sinterizada Altea en Cali | Material premium para encimeras de cocina y ba√±os con 10 a√±os de garant√≠a. Resistencia superior a qu√≠micos, manchas y altas temperaturas. Distribuidor autorizado en Valle del Cauca | Instalaci√≥n profesional | Precio competitivo.",
  Dekton:
    "Dekton piedra sinterizada Cali | Superficie ultracompacta para cocinas, ba√±os y fachadas. 25 a√±os de garant√≠a, resistencia total a rayones, manchas y calor. Distribuidor oficial Valle del Cauca | Instalaci√≥n experta | Cotizaci√≥n gratis.",
  Neolith:
    "Neolith encimeras de cocina Cali | Piedra sinterizada de lujo con 25 a√±os de garant√≠a. Resistente a rayones, manchas, UV y calor extremo. Ideal para cocinas modernas, ba√±os y exteriores | Distribuidor autorizado Cali | Mejor precio.",
  Silestone:
    "Silestone cuarzo Cali | Superficies de cuarzo para cocinas y ba√±os con tecnolog√≠a antibacteriana. 25 a√±os de garant√≠a, variedad de colores y dise√±os. Distribuidor oficial Valle del Cauca | Instalaci√≥n certificada | Financiaci√≥n disponible.",
};

const features: StoneTypeFeatures = {
  Neolith: [
    "üèÜ Piedra sinterizada de lujo",
    "üî• Resistencia extrema al calor",
    "üíé Dureza superior tipo diamante",
    "üíß Completamente impermeable",
    "üç¥ Apta para preparaci√≥n de alimentos",
    "‚òÄÔ∏è Resistente a rayos UV para exteriores",
    "üß™ Resistente a qu√≠micos y √°cidos",
    "‚≠ê 25 a√±os de garant√≠a",
    "üé® Dise√±os exclusivos y elegantes",
    "‚ôªÔ∏è 100% reciclable",
  ],
  Altea: [
    "‚ú® Superficie ultracompacta de alta resistencia",
    "üî• Soporta altas temperaturas hasta 300¬∞C",
    "üíé Resistente a qu√≠micos, √°cidos y solventes dom√©sticos",
    "üõ°Ô∏è Resistencia superior a rayones y abrasi√≥n",
    "üíß Absorci√≥n casi nula de l√≠quidos (0.02%)",
    "üç≥ Certificada para contacto directo con alimentos",
    "üè† Perfecta para interiores y exteriores",
    "‚≠ê 10 a√±os de garant√≠a del fabricante",
    "üåà Amplia variedad de colores y acabados",
    "‚ôªÔ∏è Material ecol√≥gico y reciclable",
  ],
  Dekton: [
    "üí™ Ultracompacto de m√°xima resistencia",
    "üî• Resistente a temperaturas extremas",
    "üõ°Ô∏è Resistencia total a rayones y abrasi√≥n",
    "üíß Absorci√≥n cero de l√≠quidos",
    "üçΩÔ∏è Higi√©nico para contacto con alimentos",
    "‚òÄÔ∏è Resistente a rayos UV (no se decolora)",
    "üè° Ideal para cocinas, ba√±os y exteriores",
    "‚≠ê 25 a√±os de garant√≠a Cosentino",
    "üé® M√∫ltiples dise√±os y texturas",
    "üåç Material sostenible",
  ],
  Silestone: [
    "ü¶† Tecnolog√≠a antibacteriana Microban¬Æ",
    "üíé Cuarzo natural de alta calidad",
    "üî• Resistente al calor y manchas",
    "üõ°Ô∏è Superficie no porosa",
    "üç≥ Higi√©nica para cocinas",
    "üé® +90 colores disponibles",
    "‚≠ê 25 a√±os de garant√≠a",
    "üßΩ F√°cil limpieza y mantenimiento",
    "üí™ Alta resistencia al uso diario",
    "üè† Ideal para cocinas y ba√±os",
  ],
};

// Define stone categories - ORDEN PRIORITARIO: Altea > Dekton > Neolith > Silestone
const stoneTypes = [
  { title: "Altea", folder: "PIEDRA+SINTERIZADA/ALTEA" },
  { title: "Dekton", folder: "PIEDRA+SINTERIZADA/DEKTON" },
  { title: "Neolith", folder: "PIEDRA+SINTERIZADA/NEOLITH" },
  { title: "Silestone", folder: "PIEDRA+SINTERIZADA/SILESTONE" },
];

// Fetch stone data for each category at build time
const stoneCategories = await Promise.all(
  stoneTypes.map(async (type) => {
    const stones = await listStonesFromS3(type.folder);
    // Add features to each stone
    const stonesWithFeatures = stones.map((stone) => ({
      ...stone,
      features: features[type.title],
    }));
    return {
      title: type.title,
      stones: stonesWithFeatures,
    };
  })
);

// Get the category from URL for server-side rendering of metadata
const { url } = Astro;
const params = url.searchParams;
const categoryParam = params.get("categoria")?.toLowerCase();
// Tambi√©n revisar el hash para el SEO si estamos usando anclas
const hash = url.hash ? url.hash.substring(1) : null;
const effectiveCategory = useAnchorLinks
  ? hash || categoryParam
  : categoryParam;

// Default metadata - Optimizado para SEO con enfoque en Altea
let metaTitle =
  "Piedra Sinterizada Altea, Dekton y Neolith Cali | M√°rmoles Deluxe";
let metaDescription =
  "Distribuidor oficial de piedra sinterizada en Cali: Altea, Dekton, Neolith y Silestone. Encimeras de cocina y ba√±os con garant√≠a. Instalaci√≥n profesional en Valle del Cauca. ¬°Cotizaci√≥n gratis!";
let metaImage = "/images/piedra-sinterizada-hero.jpg"; // Aseg√∫rate de tener esta imagen o cambia la ruta
let metaKeywords =
  "piedra sinterizada cali, altea cali, dekton cali, neolith cali, encimeras cocina cali, encimeras ba√±o cali, superficies cocina, m√°rmoles cali, granito cali, cuarzo cali";

// Prepare data for schema.org
let schemaCategory: string | undefined;
let schemaStones: Array<{ name: string; image: string }> = [];

// Update metadata if a valid category is specified
if (effectiveCategory) {
  const formattedCategory =
    effectiveCategory === "neolith"
      ? "Neolith"
      : effectiveCategory === "altea"
        ? "Altea"
        : effectiveCategory === "dekton"
          ? "Dekton"
          : effectiveCategory === "silestone"
            ? "Silestone"
            : null;

  if (formattedCategory) {
    metaTitle = `${formattedCategory} - Piedra Sinterizada | M√°rmoles Deluxe`;
    metaDescription = categoryDescriptions[formattedCategory];
    // Ideally, you would have category-specific images
    metaImage = `/images/piedra-sinterizada-${effectiveCategory}.jpg`;

    // Set schema.org data for this category
    schemaCategory = formattedCategory;
    const categoryData = stoneCategories.find(
      (cat) => cat.title === formattedCategory
    );
    if (categoryData) {
      schemaStones = categoryData.stones.map((stone) => ({
        name: stone.name,
        image: stone.image,
      }));
    }
  }
}

// Canonical URL (important for SEO)
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
if (useAnchorLinks && effectiveCategory) {
  // Si usamos anclas, el canonical debe incluir el hash
  canonicalURL.hash = `#${effectiveCategory}`;
} else if (categoryParam) {
  // Si usamos par√°metros, incluirlos en el canonical
  canonicalURL.searchParams.set("categoria", categoryParam);
}
---

<Layout title={metaTitle}>
  <!-- Add dynamic SEO meta tags -->
  <meta slot="head" name="description" content={metaDescription} />
  <meta slot="head" name="keywords" content={metaKeywords} />
  <meta slot="head" property="og:title" content={metaTitle} />
  <meta slot="head" property="og:description" content={metaDescription} />
  <meta slot="head" property="og:image" content={metaImage} />
  <meta slot="head" property="og:type" content="website" />
  <meta slot="head" property="og:url" content={Astro.url.href} />
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={metaTitle} />
  <meta slot="head" name="twitter:description" content={metaDescription} />
  <meta slot="head" name="twitter:image" content={metaImage} />
  <link slot="head" rel="canonical" href={canonicalURL.toString()} />

  <!-- Add Schema.org structured data for SEO -->
  <SEOSchemaData
    client:load
    pageTitle={metaTitle}
    pageDescription={metaDescription}
    pageUrl={Astro.url.href}
    pageImage={metaImage}
    category={schemaCategory}
    stones={schemaStones}
  />

  <PageLoader client:load isLoading={true} />
  <CategoryFilter client:load />

  <!-- Hero Section optimizado para SEO -->
  <section
    class="relative py-16 bg-gradient-to-br from-marmoles-black to-gray-900 text-white"
  >
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-6xl font-bold mb-4">
        Piedra Sinterizada <span class="text-marmoles-gold">Premium</span>
      </h1>
      <p class="text-xl md:text-2xl mb-6 text-gray-200">
        Distribuidor Oficial en Cali y Valle del Cauca
      </p>
      <p class="text-lg mb-8 max-w-3xl mx-auto">
        Especialistas en <strong>Altea</strong>, <strong>Dekton</strong>, <strong
          >Neolith</strong
        > y <strong>Silestone</strong>. Encimeras de cocina, ba√±os y superficies
        de alta resistencia con garant√≠a de hasta 25 a√±os.
      </p>
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <a
          href="#altea"
          class="bg-marmoles-gold text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Ver Altea ‚≠ê
        </a>
        <a
          href="#dekton"
          class="bg-white text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Ver Dekton
        </a>
        <a
          href="#neolith"
          class="bg-white text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Ver Neolith
        </a>
      </div>
      <p class="text-sm text-gray-300">
        ‚úì Instalaci√≥n Profesional | ‚úì Garant√≠a Extendida | ‚úì Cotizaci√≥n Gratuita
      </p>
    </div>
  </section>

  <main class="py-20">
    <div class="container mx-auto px-4">
      <!-- Secci√≥n de ventajas -->
      <div class="mb-16 text-center">
        <h2 class="text-3xl font-bold mb-8">
          ¬øPor qu√© elegir piedra sinterizada?
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üî•</div>
            <h3 class="font-bold mb-2">Resistencia al Calor</h3>
            <p class="text-sm text-gray-600">Soporta hasta 300¬∞C sin da√±os</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üíé</div>
            <h3 class="font-bold mb-2">Anti-Rayones</h3>
            <p class="text-sm text-gray-600">M√°xima dureza y resistencia</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üíß</div>
            <h3 class="font-bold mb-2">Impermeabilidad</h3>
            <p class="text-sm text-gray-600">Absorci√≥n casi nula de l√≠quidos</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">‚≠ê</div>
            <h3 class="font-bold mb-2">Garant√≠a</h3>
            <p class="text-sm text-gray-600">Hasta 25 a√±os de garant√≠a</p>
          </div>
        </div>
      </div>

      <CategoryWrapper
        client:load
        categories={stoneCategories}
        useAnchorLinks={useAnchorLinks}
      />
    </div>
  </main>
</Layout>

<script>
  import { initModal } from "../scripts/modal";
  initModal();

  // --- Abrir modal autom√°ticamente por par√°metro 'material' ---
  if (typeof window !== "undefined") {
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const material = params.get("material");
      if (material) {
        setTimeout(() => {
          const event = new CustomEvent("modal-state-change", {
            detail: { id: material },
          });
          document.dispatchEvent(event);
        }, 500);
      }
    });
  }
</script>
