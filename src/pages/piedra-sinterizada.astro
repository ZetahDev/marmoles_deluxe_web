---
import Layout from "../layouts/Layout.astro";
import ProductCard from "../components/ProductCard.tsx";
import CategoryFilter from "../components/CategoryFilter.tsx";
import CategoryWrapper from "../components/CategoryWrapper.tsx";
import SEOSchemaData from "../components/SEOSchemaData.tsx";
import { listStonesFromS3, type Stone } from "../lib/utils/s3Utils";

// Define stone type features
interface StoneTypeFeatures {
  [key: string]: string[];
}

// Configuraci√≥n: usar anclas (#neolith) en lugar de par√°metros (?categoria=neolith)
const useAnchorLinks = true;

// Generate category descriptions for SEO (optimizado para b√∫squedas en Google)
const categoryDescriptions = {
  Altea:
    "Piedra sinterizada Altea en Cali | Material premium para encimeras de cocina y ba√±os con 10 a√±os de garant√≠a. Resistencia superior a qu√≠micos, manchas y altas temperaturas. Distribuidor autorizado en Valle del Cauca | Instalaci√≥n profesional | Precio competitivo.",
  Dekton:
    "Dekton piedra sinterizada Cali | Superficie ultracompacta para cocinas, ba√±os y fachadas. 25 a√±os de garant√≠a, resistencia total a rayones, manchas y calor. Distribuidor oficial Valle del Cauca | Instalaci√≥n experta | Cotizaci√≥n gratis.",
  Neolith:
    "Neolith encimeras de cocina Cali | Piedra sinterizada de lujo con 25 a√±os de garant√≠a. Resistente a rayones, manchas, UV y calor extremo. Ideal para cocinas modernas, ba√±os y exteriores | Distribuidor autorizado Cali | Mejor precio.",
  Silestone:
    "Silestone cuarzo Cali | Superficies de cuarzo para cocinas y ba√±os con tecnolog√≠a antibacteriana. 25 a√±os de garant√≠a, variedad de colores y dise√±os. Distribuidor oficial Valle del Cauca | Instalaci√≥n certificada | Financiaci√≥n disponible.",
  Artemarmol:
    "Artemarmol piedra sinterizada Cali | Dise√±os exclusivos y sofisticados con tecnolog√≠a de √∫ltima generaci√≥n. Alta resistencia y formatos grandes para superficies continuas. Distribuidor oficial.",
};

const features: StoneTypeFeatures = {
  Neolith: [
    "üèÜ Piedra sinterizada de lujo",
    "üî• Resistencia extrema al calor",
    "üíé Dureza superior tipo diamante",
    "üíß Completamente impermeable",
    "üç¥ Apta para preparaci√≥n de alimentos",
    "‚òÄÔ∏è Resistente a rayos UV para exteriores",
    "üß™ Resistente a qu√≠micos y √°cidos",
    "‚≠ê 25 a√±os de garant√≠a",
    "üé® Dise√±os exclusivos y elegantes",
    "‚ôªÔ∏è 100% reciclable",
  ],
  Altea: [
    "‚ú® Superficie ultracompacta de alta resistencia",
    "üî• Soporta altas temperaturas hasta 300¬∞C",
    "üíé Resistente a qu√≠micos, √°cidos y solventes dom√©sticos",
    "üõ°Ô∏è Resistencia superior a rayones y abrasi√≥n",
    "üíß Absorci√≥n casi nula de l√≠quidos (0.02%)",
    "üç≥ Certificada para contacto directo con alimentos",
    "üè† Perfecta para interiores y exteriores",
    "‚≠ê 10 a√±os de garant√≠a del fabricante",
    "üåà Amplia variedad de colores y acabados",
    "‚ôªÔ∏è Material ecol√≥gico y reciclable",
  ],
  Dekton: [
    "üí™ Ultracompacto de m√°xima resistencia",
    "üî• Resistente a temperaturas extremas",
    "üõ°Ô∏è Resistencia total a rayones y abrasi√≥n",
    "üíß Absorci√≥n cero de l√≠quidos",
    "üçΩÔ∏è Higi√©nico para contacto con alimentos",
    "‚òÄÔ∏è Resistente a rayos UV (no se decolora)",
    "üè° Ideal para cocinas, ba√±os y exteriores",
    "‚≠ê 25 a√±os de garant√≠a Cosentino",
    "üé® M√∫ltiples dise√±os y texturas",
    "üåç Material sostenible",
  ],
  Silestone: [
    "ü¶† Tecnolog√≠a antibacteriana Microban¬Æ",
    "üíé Cuarzo natural de alta calidad",
    "üî• Resistente al calor y manchas",
    "üõ°Ô∏è Superficie no porosa",
    "üç≥ Higi√©nica para cocinas",
    "üé® +90 colores disponibles",
    "‚≠ê 25 a√±os de garant√≠a",
    "üßΩ F√°cil limpieza y mantenimiento",
    "üí™ Alta resistencia al uso diario",
    "üè† Ideal para cocinas y ba√±os",
  ],
  Artemarmol: [
    "‚ú® Dise√±os de vanguardia de alta definici√≥n",
    "üî• Resistente al calor y al fuego",
    "üíé Superficie ultracompacta resistente a rayones",
    "üíß Impermeable y f√°cil de limpiar",
    "üç≥ Apto para contacto con alimentos",
    "‚òÄÔ∏è Resistente a rayos UV para exteriores",
    "ü¶∂ Alto tr√°nsito y resistencia a la abrasi√≥n",
    "üè† Formatos grandes para menos juntas",
    "‚≠ê Calidad premium garantizada",
    "‚ôªÔ∏è Sostenible y eco-amigable",
  ],
};

// Define stone categories - ORDEN PRIORITARIO: Artemarmol > Altea > Dekton > Neolith > Silestone
// Define stone categories - ORDEN PRIORITARIO: Artemarmol > Altea > Dekton > Neolith > Silestone
const stoneTypes = [
  { title: "Artemarmol", folder: "PIEDRA+SINTERIZADA/ARTEMARMOL" },
  { title: "Altea", folder: "PIEDRA+SINTERIZADA/ALTEA" },
  { title: "Dekton", folder: "PIEDRA+SINTERIZADA/DEKTON" },
  { title: "Neolith", folder: "PIEDRA+SINTERIZADA/NEOLITH" },
  { title: "Silestone", folder: "PIEDRA+SINTERIZADA/SILESTONE" },
];

// Precios por marca (solo Altea tiene calculadora habilitada)
const preciosPorMarca: Record<
  string,
  { precioPublico: number; unidad: string } | null
> = {
  Altea: {
    precioPublico: 960000,
    unidad: "m lineal",
  },
  Dekton: null, // Sin calculadora
  Neolith: null, // Sin calculadora
  Silestone: null, // Sin calculadora
  Artemarmol: null, // Sin calculadora
};

// Fetch stone data for each category at build time
const stoneCategories = await Promise.all(
  stoneTypes.map(async (type) => {
    const stones = await listStonesFromS3(type.folder);
    const precios = preciosPorMarca[type.title];

    return {
      title: type.title,
      stones: stones,
      features: features[type.title], // Features a nivel de categor√≠a
      precioPublico: precios?.precioPublico || undefined,
      unidad: precios?.unidad || undefined,
    };
  })
);

// Get the category from URL for server-side rendering of metadata
const { url } = Astro;
const params = url.searchParams;
const categoryParam = params.get("categoria")?.toLowerCase();
// Tambi√©n revisar el hash para el SEO si estamos usando anclas
const hash = url.hash ? url.hash.substring(1) : null;
const effectiveCategory = useAnchorLinks
  ? hash || categoryParam
  : categoryParam;

// Default metadata - Optimizado para SEO con enfoque en Altea
let title = "Piedra Sinterizada Altea, Dekton y Neolith Cali | M√°rmoles Deluxe";
let description =
  "Distribuidor oficial de piedra sinterizada en Cali: Altea, Dekton, Neolith y Silestone. Encimeras de cocina y ba√±os con garant√≠a. Instalaci√≥n profesional en Valle del Cauca. ¬°Cotizaci√≥n gratis!";
let keywords =
  "piedra sinterizada cali, altea cali, dekton cali, neolith cali, silestone cali, encimeras cocina cali, encimeras ba√±o cali, superficies cocina, resistente calor, ultracompacto";

// Prepare data for schema.org
let schemaCategory: string | undefined;
let schemaStones: Array<{ name: string; image: string }> = [];

// Update metadata if a valid category is specified
if (effectiveCategory) {
  const formattedCategory =
    effectiveCategory === "neolith"
      ? "Neolith"
      : effectiveCategory === "altea"
        ? "Altea"
        : effectiveCategory === "dekton"
          ? "Dekton"
          : effectiveCategory === "silestone"
            ? "Silestone"
            : effectiveCategory === "artemarmol"
              ? "Artemarmol"
              : null;

  if (formattedCategory) {
    title = `${formattedCategory} - Piedra Sinterizada | M√°rmoles Deluxe`;
    description = categoryDescriptions[formattedCategory];

    // Set schema.org data for this category
    schemaCategory = formattedCategory;
    const categoryData = stoneCategories.find(
      (cat) => cat.title === formattedCategory
    );
    if (categoryData) {
      schemaStones = categoryData.stones.map((stone) => ({
        name: stone.name,
        image: stone.image,
      }));
    }
  }
}

// Canonical URL (important for SEO)
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
if (useAnchorLinks && effectiveCategory) {
  // Si usamos anclas, el canonical debe incluir el hash
  canonicalURL.hash = `#${effectiveCategory}`;
} else if (categoryParam) {
  // Si usamos par√°metros, incluirlos en el canonical
  canonicalURL.searchParams.set("categoria", categoryParam);
}

// Default image for SEO
const image = "/images/piedra-sinterizada-og.jpg";
---

<Layout title={title} description={description}>
  <Fragment slot="head">
    <!-- SEO Meta Tags -->
    <meta name="keywords" content={keywords} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="M√°rmoles Deluxe" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:locale" content="es_CO" />
    <meta property="og:site_name" content="M√°rmoles Deluxe" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <!-- Geo Tags -->
    <meta name="geo.region" content="CO-VAC" />
    <meta name="geo.placename" content="Cali" />
    <meta name="geo.position" content="3.4516;-76.5320" />
    <meta name="ICBM" content="3.4516, -76.5320" />
  </Fragment>

  <!-- Add Schema.org structured data for SEO -->
  <SEOSchemaData
    client:idle
    pageTitle={title}
    pageDescription={description}
    pageUrl={Astro.url.href}
    pageImage={image}
    category={schemaCategory}
    stones={schemaStones}
  />

  <CategoryFilter client:idle />

  <!-- Hero Section optimizado para SEO -->
  <section
    class="relative py-16 bg-gradient-to-br from-marmoles-black to-gray-900 text-white"
  >
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-6xl font-bold mb-4">
        Piedra Sinterizada <span class="text-marmoles-gold">Premium</span>
      </h1>
      <p class="text-xl md:text-2xl mb-6 text-gray-200">
        Distribuidor Oficial en Cali y Valle del Cauca
      </p>
      <p class="text-lg mb-8 max-w-3xl mx-auto">
        Especialistas en <strong>Artemarmol</strong>, <strong>Altea</strong>, <strong
          >Dekton</strong
        >, <strong>Neolith</strong> y <strong>Silestone</strong>. Encimeras de
        cocina, ba√±os y superficies de alta resistencia con garant√≠a de hasta 25
        a√±os.
      </p>
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <a
          href="#artemarmol"
          class="bg-marmoles-gold text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Artemarmol
        </a>
        <a
          href="#altea"
          class="bg-white text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Altea
        </a>
        <a
          href="#dekton"
          class="bg-white text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Dekton
        </a>
        <a
          href="#neolith"
          class="bg-white text-marmoles-black px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all"
        >
          Neolith
        </a>
      </div>
      <p class="text-sm text-gray-300">
        ‚úì Instalaci√≥n Profesional | ‚úì Garant√≠a Extendida | ‚úì Cotizaci√≥n Gratuita
      </p>
    </div>
  </section>

  <main class="py-20">
    <div class="container mx-auto px-4">
      <!-- Secci√≥n de ventajas -->
      <div class="mb-16 text-center">
        <h2 class="text-3xl font-bold mb-8">
          ¬øPor qu√© elegir piedra sinterizada?
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üî•</div>
            <h3 class="font-bold mb-2">Resistencia al Calor</h3>
            <p class="text-sm text-gray-600">Soporta hasta 300¬∞C sin da√±os</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üíé</div>
            <h3 class="font-bold mb-2">Anti-Rayones</h3>
            <p class="text-sm text-gray-600">M√°xima dureza y resistencia</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">üíß</div>
            <h3 class="font-bold mb-2">Impermeabilidad</h3>
            <p class="text-sm text-gray-600">Absorci√≥n casi nula de l√≠quidos</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="text-4xl mb-3">‚≠ê</div>
            <h3 class="font-bold mb-2">Garant√≠a</h3>
            <p class="text-sm text-gray-600">Hasta 25 a√±os de garant√≠a</p>
          </div>
        </div>
      </div>

      <CategoryWrapper
        client:load
        categories={stoneCategories}
        useAnchorLinks={useAnchorLinks}
      />
    </div>
  </main>
</Layout>

<script>
  import { initModal } from "../scripts/modal";
  initModal();

  // --- Abrir modal autom√°ticamente por par√°metro 'material' ---
  if (typeof window !== "undefined") {
    const triggerMaterialModal = () => {
      const params = new URLSearchParams(window.location.search);
      const material = params.get("material");

      if (material) {
        // Normalizar el material parameter a slug format
        const normalizedMaterial = material
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

        // Intentar abrir el modal m√∫ltiples veces para asegurar que React est√© listo
        let attempts = 0;
        const maxAttempts = 5;

        const tryOpenModal = () => {
          attempts++;
          const event = new CustomEvent("modal-state-change", {
            detail: { id: normalizedMaterial },
          });
          document.dispatchEvent(event);

          // Verificar si alg√∫n modal se abri√≥ (comprobando si hay un modal visible)
          setTimeout(() => {
            const modalVisible =
              document.querySelector("[data-modal-backdrop]") ||
              document.body.style.overflow === "hidden";
            if (!modalVisible && attempts < maxAttempts) {
              // Reintentar despu√©s de un tiempo m√°s largo
              setTimeout(tryOpenModal, 500);
            }
          }, 100);
        };

        // Esperar un poco m√°s para que React hidrate los componentes
        setTimeout(tryOpenModal, 800);
      }
    };

    // Usar DOMContentLoaded y tambi√©n un listener de load como respaldo
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", triggerMaterialModal);
    } else {
      triggerMaterialModal();
    }
  }
</script>
